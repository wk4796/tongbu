# 个人自用网盘间数据同步脚本(先从源目标下载文件()到vps硬盘，然后在陆续往其他目标上传文件)
# ⌨️ 在您想要安装的机器上，进入目标目录，执行以下命令即可：
```
source <(curl -sL https://raw.githubusercontent.com/wk4796/tongbu/main/install_tongbu.sh)
```
### 脚本别名为：`tongbu`
直接输入`tongbu`就可以进入脚本
---
# 重新连接 SSH 后，想要回到之前那个“正在跑进度条”的界面，只需要运行一条命令。
核心命令：回到现场
登录 SSH 后，直接输入以下命令并回车：
```
tmux attach -t tongbu_session
```
(注意：tongbu_session 是我们在脚本里写死的会话名称，专门用来跑这个同步任务的。)
---

# 如果你想中途停止正在运行的同步任务，取决于你当前是在 “看着进度条” 还是在 “普通命令行”，有以下几种方法。
### 情况 1：你当前正在查看进度 (在 Tmux 窗口内)
如果你能看到 Rclone 的进度条在跳动：
1. **快捷键停止：**
直接按下键盘上的 **`Ctrl` + `C**`。
* *注意：* 由于脚本是循环执行的，有时候按一次只能停掉当前正在传的这个文件，脚本可能会立即尝试传下一个。如果按一次停不下来，请**连续猛按几次 `Ctrl` + `C**`，直到出现命令行提示符（例如 `root@vps:~#`）。
2. **直接关闭 Tmux 窗口 (更彻底)：**
如果你不想狂按 Ctrl+C，可以直接杀死当前的 Tmux 窗口：
* 按下 **`Ctrl` + `B**`，松开。
* 然后按 **`&`** (通常是 `Shift` + `7`)。
* 屏幕下方会问 `kill-window? (y/n)`，输入 **`y`** 并回车。
---

### 情况 2：你当前在普通命令行 (看不到进度)
如果你不在 Tmux 里，或者刚刚断开 SSH 重连回来：
**推荐方法：直接杀死后台会话**
只需要运行这一行命令，任务就会立即彻底停止：
```
tmux kill-session -t tongbu_session
```
运行后，后台那个叫 `tongbu_session` 的任务就会彻底消失。

---

### 情况 3：核弹级清理 (强制停止所有任务)
如果你感觉系统卡住了，或者不确定有没有残留的 Rclone 进程在偷偷跑，可以使用“核弹”命令清理战场：
强制杀死所有名为 rclone 的进程
```
pkill -9 rclone
```
或者：
强制杀死所有 tmux 会话（慎用，会关闭所有后台窗口）
```
pkill -9 tmux
```
---
### 总结

* **温柔停止：** 进窗口按 `Ctrl + C`。
* **最快停止：** 在外面运行 `tmux kill-session -t tongbu_session`。

---

# 📂 Rclone 动态多路同步工具 (`tongbu.sh`) 使用指南

## 1. 工具简介
本脚本旨在解决 VPS 中转传输时的效率与自动化问题。它能自动对比源目录和目标目录，仅下载增量文件到 VPS 本地缓存，然后分发到多个目标网盘，最后自动清理缓存。

**适用场景**：将 WebDAV/网盘 A 的文件，自动同步到网盘 B 和网盘 C。
---

## ⚠️ 核心警示：如何防止 VPS 硬盘爆满（必读）
在使用本工具时，**90% 的“写入错误 (Input/output error)”都是因为目标路径填写不当导致的“双重空间占用”。**
### ❌ 错误的做法（新手陷阱）

在输入“目标路径”时，填写了 **VPS 本地的挂载路径**，例如：
> `/xiazai/rclone/天翼云盘/电影/`
* **后果**：触发 **Rclone VFS 缓存机制**。
* **原理**：文件会被下载到脚本的 `/tmp` 缓存目录（占用一份空间），然后复制到挂载点时，Rclone 会在系统缓存区（`/root/.cache`）再生成一份副本用于上传（占用第二份空间）。
* **结局**：**1G 的文件会占用 2G 的硬盘**。如果你的 VPS 硬盘较小，上传速度又慢于下载速度，缓存堆积会导致硬盘瞬间爆满，脚本报错崩溃。

### ✅ 正确的做法（推荐）
在输入“目标路径”时，直接填写 **Rclone 配置名 + 路径**，例如：
> `CT_Cloud:/电影/`
> *(格式：`配置名称:路径`，注意中间的冒号)*

* **优势**：触发 **流式传输模式**。
* **原理**：脚本直接调用 Rclone API，从 `/tmp` 读取文件流直接上传到云端，**不经过本地挂载点的缓存层**。
* **结局**：**1G 的文件只占用 1G 的临时空间**。上传完成后立即释放，极大节省 VPS 空间，且速度更快、更稳定。

---
## 2. 详细操作步骤

### 第一步：启动脚本
建议在 `tmux` 或 `screen` 后台运行，防止网络断开导致任务中断。
```
bash tongbu.sh
```

### 第二步：配置源路径 (From)
脚本会询问文件从哪里来。
* 如果你已将源网盘挂载到本地，可以直接填本地路径（如 `/mnt/source`）。
* 也可以填网盘配置路径（如 `SourceDrive:/data`）。

### 第三步：配置目标路径 (To) —— **关键步骤**
脚本会询问你要同步到几个地方，以及具体的路径。
* **请务必遵循“核心警示”中的建议，填写 `网盘配置名:路径`。**
* *如何查看配置名？* 脚本界面上方会列出当前所有的 Rclone Remotes（带冒号的名称）。

### 第四步：设置缓存与并发
* **临时缓存路径**：默认 `/tmp/tongbu_cache`。确保该分区有至少容纳最大单文件的空间。
* **批次大小**：默认为 `2`。
* VPS 硬盘越小，这个数字应该越小（建议 1 或 2）。
* VPS 硬盘很大，可以适当增加以提高速度。

---
## 3. 常见问题排查 (Troubleshooting)

### Q1: 运行中出现 `Input/output error`，传输失败？
**原因**：VPS 硬盘空间满了。
**解决**：

1. 按 `Ctrl+C` 停止脚本。
2. 运行 `df -h` 检查磁盘占用。
3. 运行 `rm -rf /tmp/tongbu_cache/*` 清理脚本缓存。
4. **检查 `~/.cache/rclone` 是否有残留缓存并清理。**
5. **重新运行脚本，确保“目标路径”使用的是 `配置名:路径` 格式，而不是 `/本地/挂载/路径`。**

### Q2: 屏幕上出现 `^[[B` 或 `^[[A` 这种乱码？
**原因**：这是正常的 Linux 终端回显。脚本在全力运行传输任务时，如果你按下了方向键或滚动了鼠标滚轮，这些信号会直接显示在屏幕上。
**解决**：这不影响文件传输，纯属视觉干扰。建议在进度条跑动时，不要操作键盘或鼠标。

### Q3: 为什么空间占用会不断增长？
**原因**：上传速度 < 下载/复制速度。
**解释**：脚本下载很快，但上传受限于宽带上行。如果使用了挂载路径（错误做法），积压的待上传文件会堆满缓存区。改为使用 API 路径（正确做法）配合较小的“批次大小”（如每次 1 个），可以有效缓解此问题。

---
## 4. 维护与清理
脚本会在每次任务正常结束后自动清理 `/tmp/tongbu_cache`。如果脚本异常退出（如强制中断或断电），建议手动运行以下命令清理垃圾：
```
rm -rf /tmp/tongbu_cache
```
